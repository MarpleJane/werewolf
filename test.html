<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<!-- <link href="css/quill.css" rel="stylesheet"> -->
</head>
<body>
	<div id="init">
		房间号：<input type="text" id="room">
		名字：<input type="text" id="name">
	</div>
	<button onclick="goToRoom()" id="btn-init">确定</button>

	<div id="character"></div>
	<div id="current-info"></div>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script>
		function aliveParser(data) {
			var alive = data.alive;
			console.log(alive);
			var alive_html = "<div>活着的：</div><div>";
			for (var i = 0; i < alive.length; i ++) {
				alive_html += "<button>" + i + "." + alive[i].username + "</button>";
			}
			alive_html += "</div><div>输入要杀谁<input type='text' id='wolf-input'><button id='wolf-confirm'>确认</button></div>";
			return alive_html;
		}

        function youAreWolf(data) {
			var counterpart = data.wolves;
			var alive = data.alive;
			var cp_html = "<div>所有的狼:";
			for (var i = 0; i < counterpart.length; i ++) {
				cp_html += counterpart[i].username + "; ";
			}
			cp_html += "</div>";
			var alive_html = aliveParser(data);
			// console.log(cp_html + alive_html);
			return cp_html + alive_html;
		}

		function youAreWitch(data) {
			var alive = data.alive;
			var dead = data.dead;
			var player_skill = data.player_skill;
			var poison = player_skill.Poison_Number;
			var antidote = play_skill.Antidote_Number;
			var witch_html = "<div>"
			for (var i = 0; i < dead.length; i ++) {
				witch_html += i + "." + dead.username + ", ";
			}
			witch_html += "死了，你要救吗?</div><div>这些人还活着，要毒谁?</div><div>";
			for (var i = 0; i < alive.length; i ++) {
				witch_html += "<button>" + i + "." + alive[i].username + "</button>";
			}
			witch_html += "</div><div>";
			witch_html += "要救谁：<input type='text' id='witch-save'" + (!antidote ? " disabled" : "") + ">";
			witch_html += "要杀谁：<input type='text' id='witch-kill'" + (!poison ? " disabled" : "") + ">" + 
			    "<button id='witch-confirm'>完成</button>";
			return witch_html;
		}

		function youAreSeer(data) {
			var all_players = data.all_players;
			var seer_html = "<div>活着的："
			for (var i = 0; i < all_players.length; i ++) {
				seer_html += "<button>" + i + "." + all_players[i].username + "</button>";
			}
			seer_html += "</div>";
			seer_html += "<div>要验谁：<input type='text' id='seer-input'><button id='seer-check'>开验</button></div>" +
			    "<div id='seer-result'></div>";
			return seer_html;
		}

		function youAreHunter(data) {

		}

		function youAreDeadHunter(data) {
			var player_skill = data.player_skill;
			var hunt = player_skill.Hunt;
			var alive = data.alive;
			var hunter_html = "<div>"
			for (var i = 0; i < alive.length; i ++) {
				hunter_html += "<button>" + i + "." + alive[i].username + "</button>";
			}
			hunter_html += "</div>";
			hunter_html += "<div>带走谁：<input type='text' id='hunter-input'" + (!hunt ? " disabled" : "") + ">"  + 
			    "<button id='hunter-confirm'>确定</button>" + "<button id='hunter-cancel>取消</button>";
			return hunter_html;
		}

		function nightStatus(data) {
			var all_alive = data.all_alive;
			var dead = data.dead;
			var current_status = data.current_status;
			var night_html = "<div>昨天 ";
			if (dead.length == 0) {
				night_html = "没有人死</div>";
			} else {
				for (var i = 0; i < dead.length; i ++) {
					night_html += dead.username + ", ";
				}
				night_html += "死了</div><div>开始投票";
				for (var i = 0; i < all_alive.length; i ++) {
					night_html += "<button>" + i + "." + all_alive[i].username + "</button>";
				}
				night_html += "</div>";
				night_html += "<div>投票：<input type='text' id='vote-input'" + (!current_status ? " disabled" : "") + "></div>";
			}
			night_html += "<button id='vote-confirm'>确定</button>";
			return night_html;
		}

		function startVote(data) {
			var all_alive = data.all_alive;
			var vote_html = "开始投票";
			for (var i = 0; i < all_alive.length; i ++) {
				vote_html += 
			}
		}


		// function youAreWitchKill(data) {
		// 	var alive = data.alive;
		// 	var kill_html = "<div>";
		// 	for (var i = 0; i < alive.length; i ++) {
		// 		kill_html += "<button>" + i + "." + alive[i].username + "</button>";
		// 	}
		// 	kill_html += "</div><div>要杀谁<input type='text' id='witch-kill'><button id='witch-kill-conf'>确认</button>" +
		// 	    "<button id='witch-kill-canl'>不杀</button>";
		// 	return kill_html;
		// }

		function goToRoom() {
			window.room = document.getElementById("room").value;
			var name = document.getElementById("name").value;
			window.ws = new WebSocket("ws://127.0.0.1:8888/CreateConnection?no=" + room + "&name=" + name);
			ws.onmessage = function(event) {
				window.data = JSON.parse(event.data);
				var ret = data.ret;
				if (ret === 0) {
					document.getElementById('btn-init').disabled = true;
					var current_num = data.current_num;
					document.getElementById("current-info").innerHTML = "当前有" + current_num + "人";
				} else if (ret === 1) {
					var msg = data.msg;
					document.getElementById("current-info").innerHTML = msg;
				} else if (ret === 2) {
					document.getElementById('btn-init').disabled = true;
					var character = data.your_character;
					window.your_uid = data.your_uid;
					document.getElementById("character").innerHTML = "你是" + character;
					document.getElementById("current-info").innerHTML = "天黑了请闭眼";
					if (character == "wolf") {
				        document.getElementById("current-info").innerHTML = "狼人请睁眼" + youAreWolf(data);
						$("#wolf-confirm").click(function() {
							console.log(window.data);
							var kill = parseInt(document.getElementById("wolf-input").value);
							var alive = window.data.alive;
							var uid = alive[kill].uid;
							window.ws.send(JSON.stringify({ret: "witch", kill: uid, current_player: "wolf"}));
							document.getElementById("current-info").innerHTML = "狼人请闭眼";
						})
					}
				} else if (ret === 3) {
					document.getElementById("current-info").innerHTML = "天黑了请闭眼";
					var current_character = data.current_character;
					var current_status = data.current_status;
					if (current_status) {
						switch (current_character) {
							case "witch": 
							     document.getElementById("current-info").innerHTML = "女巫请睁眼" + youAreWitchSave(data);
								 $("#witch-confirm").click(function() {
									 var save = parseInt(document.getElementById("witch-save").value) || -1;
									 var kill = parseInt(document.getElementById("witch-cancel").value) || -1;
									 var alive = window.data.alive;
									 var dead = window.data.dead;
									 save = dead[save] ? dead[save].uid : 0;
									 kill = alive[kill] ? alive[kill].uid : 0;
									 window.ws.send(JSON.stringify({ret: "seer", kill: kill, save: save, current_player: "witch", uid: window.your_uid}));
								 });
								 break;
							case "seer":
							    document.getElementById("current-info").innerHTML = "预言家请睁眼" + youAreSeer(data);
							    $("#seer-check").click(function() {
							    	var check = parseInt(document.getElementById("seer-input").value);
							    	var all_players = window.data.all_players;
							    	var target = all_players[check];
							    	document.getElementById('seer-result').innerHTML = target.username + "是" + target.character +
							    	    "<button id='seer-confirm'>确认</button>"；
							    	$("#seer-confirm").click(function() {
							    		window.ws.send(JSON.stringify({ret: "hunter", kill: 0, save: 0, current_player: "seer", uid: window.your_uid}));
							    	})
							    })
							    break;
							case "hunter":
							    document.getElementById("current-info").innerHTML = "猎人请睁眼" + "你还活着" + "<button id='hunter-confirm'>确定</button>";
							    $("#hunter-confirm").click(function() {
							    	window.ws.send(JSON.stringify({ret: "all", kill: 0, save: 0, current_player: "hunter", uid: window.your_uid}));
							    })
							    break;
					    }
					} else {
						switch (current_character) {
							case "witch": window.ws.send(JSON.stringify({ret: "seer", kill: 0, save: 0, current_player: "witch", uid: window.your_uid}));
							    break;
							case "seer": window.ws.send(JSON.stringify({ret: "hunter", kill: 0, save: 0, current_player: "seer", uid: window.your_uid}));
							    break;
							case "hunter": document.getElementById("current-info").innerHTML = "猎人请睁眼" + "你已经死了要带走谁?" + youAreDeadHunter(data);
							    $("#hunter-confirm").click(function() {
							    	var kill = parseInt(document.getElementById("hunter-input").value) || -1;
							    	var alive = window.data.alive;
							    	kill = alive[kill] ? alive[kill].uid : 0;
							    	window.ws.send(JSON.stringify({ret: "all", kill: 0, save: 0, current_player: "hunter", uid: window.your_uid}))
							    })
							    break;
						}
					}
					
				} else if (ret === 4) {
					var win = data.win;
					if (win == 0) {
						document.getElementById("current-info").innerHTML = "狼人获胜" + "<button id='exit'>游戏结束</button>";
						$("#exit").click(function() {
							window.ws.close();
						});
					} else if (win == 1) {
						document.getElementById("current-info").innerHTML = "好人赢了" + "<button id='exit'>游戏结束</button>";
						$("#exit").click(function() {
							window.ws.close();
						});
					} else if (win == 2) {
						document.getElementById("current-info").innerHTML = nightStatus(data);
						$("#vote-confirm").click(function() {
							var vote_input = document.getElementById("vote_input");
							var input_value = -1
							if (vote_input != null) {
								input_value = parseInt(vote_input.value) || -1;
							}
							var all_alive = window.data.all_alive;
							var vote_to = all_alive[input_value] ? all_alive[input_value].uid : 0;
							window.ws.send(JSON.stringify({ret: "vote", current_player: "all", vote: vote_to, uid: window.your_uid}));
						})
					}
				} else if (ret === 5) {
					var current_status = data.current_status;
					var voted = data.voted;
					var vote_num = data.vote_num;
					document.getElementsById("current-info").innerHTML = "<div>" + vote_num + "人已投票</div>"; 
				} else if (ret === 6) {

				}
			};
		}

        // $("body").on("click", "#wolf-confirm", function() {
		// 	console.log(window.data);
		// 	var kill = parseInt(document.getElementById("wolf-input").value);
		// 	var alive = window.data.alive;
		// 	var uid = alive[kill].uid;
		// 	window.ws.send(JSON.stringify({ret: "witch", kill: uid}));
		// })
				
	</script>

</body>
</html>